<div class="signup-container">
  <div class="logo-container">
    <img src="assets/onredboot-logo.jpg" alt="OneRedBoot Logo">
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="signup-form">
    <!-- Initial Signup -->
    <ng-container *ngIf="currentStep === 0">
      <h2>Create Account</h2>

      <div class="form-group">
        <input
          type="email"
          formControlName="username"
          placeholder="Email address"
          class="form-input"
          [class.error]="form.get('username')?.touched && form.get('username')?.invalid">

        <div class="error-message" *ngIf="form.get('username')?.touched && form.get('username')?.invalid">
          <span *ngIf="form.get('username')?.errors?.['required']">Email is required</span>
          <span *ngIf="form.get('username')?.errors?.['email']">Invalid email format</span>
        </div>
      </div>

      <div class="form-group">
        <div class="password-input-container">
          <input
            [type]="passwordVisible ? 'text' : 'password'"
            formControlName="password"
            placeholder="Password"
            class="form-input"
            [class.error]="form.get('password')?.touched && form.get('password')?.invalid">
          <button
            type="button"
            class="password-toggle"
            (click)="togglePasswordVisibility()">
            <span class="eye-icon">üëÅ</span>
          </button>
        </div>

        <div class="error-message" *ngIf="form.get('password')?.touched && form.get('password')?.invalid">
          <span *ngIf="form.get('password')?.errors?.['required']">Password is required</span>
          <span *ngIf="form.get('password')?.errors?.['pattern']">
            Password must contain at least 8 characters, including uppercase, lowercase, numbers, and special characters
          </span>
        </div>
      </div>

      <div class="form-group">
        <h3>Choose Authentication Method</h3>
        <div class="mfa-options">
          <div class="mfa-option">
            <input
              type="radio"
              id="totp"
              formControlName="mfaType"
              [value]="MFAType.TOTP">
            <label for="totp">
              <span class="option-title">Authenticator App</span>
              <span class="option-description">Use Google Authenticator, Authy, or similar apps</span>
            </label>
          </div>

          <div class="mfa-option">
            <input
              type="radio"
              id="sms"
              formControlName="mfaType"
              [value]="MFAType.SMS">
            <label for="sms">
              <span class="option-title">SMS Authentication</span>
              <span class="option-description">Receive codes via text message</span>
            </label>
          </div>
        </div>

        <div *ngIf="form.get('mfaType')?.value === MFAType.SMS" class="phone-input">
          <input
            type="tel"
            formControlName="phoneNumber"
            placeholder="Phone number (+1234567890)"
            class="form-input"
            [class.error]="form.get('phoneNumber')?.touched && form.get('phoneNumber')?.invalid">

          <div class="error-message" *ngIf="form.get('phoneNumber')?.touched && form.get('phoneNumber')?.invalid">
            <span *ngIf="form.get('phoneNumber')?.errors?.['required']">Phone number is required for SMS authentication</span>
            <span *ngIf="form.get('phoneNumber')?.errors?.['pattern']">Please enter a valid phone number (+1234567890)</span>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- MFA Setup -->
    <ng-container *ngIf="currentStep === 1">
      <h2>Set Up Two-Factor Authentication</h2>
      <p class="mfa-instructions">Scan this QR code with your authenticator app:</p>

      <div class="qr-container">
        <img [src]="qrCode" alt="QR Code for authenticator setup" *ngIf="qrCode">
      </div>

      <div class="secret-key-container">
        <p>Or manually enter this code in your authenticator app:</p>
        <code class="secret-key">{{ secretKey }}</code>
      </div>

      <div class="form-group">
        <input
          type="text"
          formControlName="mfaCode"
          placeholder="Enter 6-digit code"
          class="form-input"
          maxlength="6"
          [class.error]="form.get('mfaCode')?.touched && form.get('mfaCode')?.invalid">

        <div class="error-message" *ngIf="form.get('mfaCode')?.touched && form.get('mfaCode')?.invalid">
          <span *ngIf="form.get('mfaCode')?.errors?.['pattern']">Enter a valid 6-digit code</span>
        </div>
      </div>
    </ng-container>

    <!-- Email Verification -->
    <ng-container *ngIf="currentStep === 2">
      <h2>Verify Your Email</h2>
      <p>Enter the verification code sent to your email</p>

      <div class="form-group">
        <input
          type="text"
          formControlName="verificationCode"
          placeholder="Enter verification code"
          class="form-input"
          maxlength="6"
          [class.error]="form.get('verificationCode')?.touched && form.get('verificationCode')?.invalid">

        <div class="error-message" *ngIf="form.get('verificationCode')?.touched && form.get('verificationCode')?.invalid">
          <span *ngIf="form.get('verificationCode')?.errors?.['pattern']">Enter a valid 6-digit code</span>
        </div>
      </div>
    </ng-container>

    <!-- Error Message -->
    <div class="error-banner" *ngIf="error">
      {{ error }}
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      class="submit-button"
      [disabled]="!isStepValid() || isLoading">
      <span *ngIf="!isLoading">
        {{ currentStep === 0 ? 'Create Account' :
        currentStep === 1 ? 'Verify MFA' :
          'Complete Registration' }}
      </span>
      <div class="loader" *ngIf="isLoading"></div>
    </button>

    <!-- Sign In Link -->
    <div class="form-links">
      <div class="signin-prompt">
        Already have an account? <a routerLink="/signin">Sign In</a>
      </div>
    </div>
  </form>
</div>
